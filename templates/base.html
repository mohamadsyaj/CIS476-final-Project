<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{% block title %}MyPass{% endblock %}</title>
    <link rel="stylesheet" href="/static/mypass.css">
    <script src="/static/mypass.js" defer></script>
  </head>
  <body>
    <nav style="padding:12px;">
      {% if session.user_id %}
        <a href="/">Home</a> | <a href="/vault">Vault</a> | <a href="/vault/add">Add Item</a> | <a href="/logout">Logout</a>
      {% else %}
        <a href="/register">Register</a> | <a href="/login">Login</a>
      {% endif %}
    </nav>
    <div class="container"><div class="card">{% block content %}{% endblock %}</div></div>

    <!-- Small resilient JS fallback: ensures toggle-password buttons work and
         makes "Clear notifications" perform an AJAX POST so the UI updates
         without depending on other page scripts. This complements
         `/static/mypass.js` and helps in environments where scripts fail. -->
    <script>
      (function(){
        // Delegate toggle-password clicks
        document.addEventListener('click', function(e){
          const btn = e.target.closest && e.target.closest('button.toggle-password');
          if (!btn) return;
          e.preventDefault();
          const targetId = btn.dataset && btn.dataset.target;
          if (!targetId) return;
          const input = document.getElementById(targetId);
          if (!input) return;
          if (input.type === 'password'){
            input.type = 'text'; btn.textContent = 'Hide';
          } else {
            input.type = 'password'; btn.textContent = 'Show';
          }
        }, true);

        // Intercept the notifications clear form to do a fetch POST and update UI
        document.addEventListener('submit', function(e){
          const form = e.target;
          if (!form || form.action === undefined) return;
          // match the clear notifications route
          if (form.getAttribute('action') && form.getAttribute('action').endsWith('/notifications/clear')){
            e.preventDefault();
            fetch(form.action, {method: 'POST', credentials: 'same-origin'})
              .then(r => {
                // if redirect, reload to reflect server state; otherwise remove list
                if (r.redirected) { window.location.href = r.url; return; }
                // remove notifications list from DOM if present
                const list = document.getElementById('notifications-list');
                if (list) { list.innerHTML = '<li class="small-muted">No new notifications</li>'; }
                // also show a small flash if available
                try{ const flash = document.createElement('div'); flash.className='flash-message success'; flash.textContent='Notifications cleared.'; document.body.insertBefore(flash, document.body.firstChild); setTimeout(()=>flash.remove(),3000);}catch(e){}
              }).catch(()=>{ /* ignore */ });
          }
        }, true);
      })();
    </script>
    </body>
  </html>
